"use strict";var h=Object.create;var u=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var y=(a,e)=>{for(var t in e)u(a,t,{get:e[t],enumerable:!0})},g=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of f(e))!m.call(a,n)&&n!==t&&u(a,n,{get:()=>e[n],enumerable:!(i=_(e,n))||i.enumerable});return a};var w=(a,e,t)=>(t=a!=null?h(v(a)):{},g(e||!a||!a.__esModule?u(t,"default",{value:a,enumerable:!0}):t,a)),x=a=>g(u({},"__esModule",{value:!0}),a);var E={};y(E,{default:()=>A});module.exports=x(E);var l=w(require("knex")),d=class{constructor(e,t){this.knex=e;this.logger=t}started_at=new Date;finished_at;_config="phoenix";_connections="external_connections";_serviceAccounts="service_accounts";_result_alpha;_result_omega;_distinct_alpha;_distinct_omega;_base_alpha;get config(){return this.knex(this._config)}get connection(){return this.knex(this._connections)}get serviceAccount(){return this.knex(this._serviceAccounts)}getConnection=async e=>await this.connection.select("service_account","host","port","driver").where("uuid",e).first();getServiceAccount=async e=>await this.serviceAccount.select("username","password").where("uuid",e).first();rawQuery=async(e,t,i)=>{let n=t.trim(),r=i?`SELECT * FROM OPENQUERY(${i}, '${n.replaceAll("'","''")}');`:n;return await e.raw(r)};start=async e=>{let t=await this.config.where("uuid",e).first(),i=await this.getConnection(t.connection_alpha),n=await this.getConnection(t.connection_omega),r=await this.getServiceAccount(i.service_account),s=await this.getServiceAccount(n.service_account),o,c;try{o=(0,l.default)({client:i.driver,connection:{host:i.host,port:i.port,user:r.username,password:r.password,database:t.database_alpha??""}})}catch(p){this.logger.error(`ALPHA CONNECTION: ${p.message}`)}try{c=(0,l.default)({client:n.driver,connection:{host:n.host,port:n.port,user:s.username,password:s.password,database:t.database_omega??""}})}catch(p){this.logger.error(`OMEGA CONNECTION: ${p.message}`)}if(!(!o||!c)){if(t.advanced_mode)try{this.advanced_phoenix(t,o,c)}catch(p){this.logger.error(p.message)}return{config:t,connection_alpha:i,connection_omega:n,service_account_alpha:r,service_account_omega:s}}};advanced_phoenix=async(e,t,i)=>{let[n,r]=await Promise.all([this.rawQuery(t,e.advanced_query_alpha,e.linked_name_alpha),this.rawQuery(i,e.advanced_query_omega,e.linked_name_omega)]);this.logger.info(`ALPHA: ${n.length}`),this.logger.info(`OEMGA: ${r.length}`);let s=n.filter(o=>[...new Set(r.map(c=>c.COMPANY_CODE))].includes(o.COMPANY_CODE));this.logger.info(`BASE: ${s.length}`),this.logger.info("FINISHED")}};var A={id:"phoenix",handler:(a,{database:e,logger:t})=>{a.put("/:uuid",async(i,n)=>{let r=i.params.uuid,o=await new d(e,t).start(r);n.json(o)})}};0&&(module.exports={});
